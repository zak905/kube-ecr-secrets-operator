apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    control-plane: controller-manager
{{- include "kube-ecr-secrets-operator.selectorLabels" . | nindent 4 }}
  name: {{ include "kube-ecr-secrets-operator.name" . }}-controller-manager
spec:
  replicas: 1
  selector:
    matchLabels:
      control-plane: controller-manager
  template:
    metadata:
      annotations:
        kubectl.kubernetes.io/default-container: manager
    {{- if .Values.podAnnotations }}
{{ toYaml .Values.podAnnotations | indent 8 }}
    {{- end }}
      labels:
        control-plane: controller-manager
{{- include "kube-ecr-secrets-operator.selectorLabels" . | nindent 8 }}
    spec:
      initContainers:
      - name: cert-init
        image: alpine:3.21
        command:
        - sh
        - -c
        - |
          set -e
          apk add --no-cache curl openssl > /dev/null 2>&1
          NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
          CERT_DIR=/tmp/k8s-webhook-server/serving-certs
          mkdir -p "$CERT_DIR"
          openssl genrsa -out /tmp/ca.key 2048
          openssl req -new -x509 -days 36500 -key /tmp/ca.key -out /tmp/ca.crt -subj "/CN=kube-ecr-secrets-operator-ca"
          openssl genrsa -out "$CERT_DIR/tls.key" 2048
          printf '[req]\nreq_extensions = v3_req\ndistinguished_name = req_distinguished_name\n[req_distinguished_name]\n[v3_req]\nbasicConstraints = CA:FALSE\nkeyUsage = digitalSignature, keyEncipherment\nsubjectAltName = @alt_names\n[alt_names]\n' > /tmp/san.cnf
          printf 'DNS.1 = %s.%s.svc\nDNS.2 = %s.%s.svc.cluster.local\n' "$SERVICE_NAME" "$NAMESPACE" "$SERVICE_NAME" "$NAMESPACE" >> /tmp/san.cnf
          openssl req -new -key "$CERT_DIR/tls.key" -out /tmp/server.csr -subj "/CN=${SERVICE_NAME}.${NAMESPACE}.svc" -config /tmp/san.cnf
          openssl x509 -req -days 36500 -in /tmp/server.csr -CA /tmp/ca.crt -CAkey /tmp/ca.key -CAcreateserial -out "$CERT_DIR/tls.crt" -extensions v3_req -extfile /tmp/san.cnf
          CA_BUNDLE=$(base64 -w 0 /tmp/ca.crt)
          TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
          K8S_CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          curl -sf -X PATCH \
            --cacert "$K8S_CA" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json-patch+json" \
            "https://kubernetes.default.svc/apis/admissionregistration.k8s.io/v1/mutatingwebhookconfigurations/${WEBHOOK_CONFIG_NAME}" \
            -d "[{\"op\": \"add\", \"path\": \"/webhooks/0/clientConfig/caBundle\", \"value\": \"${CA_BUNDLE}\"}]"
          echo "Done: TLS certificate generated and webhook configuration patched."
        env:
        - name: SERVICE_NAME
          value: {{ include "kube-ecr-secrets-operator.name" . }}-webhook-service
        - name: WEBHOOK_CONFIG_NAME
          value: {{ include "kube-ecr-secrets-operator.name" . }}-mutating-webhook-configuration
        securityContext:
          allowPrivilegeEscalation: false
        volumeMounts:
        - mountPath: /tmp/k8s-webhook-server/serving-certs
          name: cert
      containers:
      - command:
        - /manager
        {{- $imageTag := .Values.image.tag -}}
      {{- if .Chart.AppVersion }}
        {{- $imageTag = .Chart.AppVersion -}}
      {{- end }}
        image: {{ .Values.image.repository }}:{{ $imageTag }}
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8081
          initialDelaySeconds: 15
          periodSeconds: 20
        name: manager
        ports:
        - containerPort: 9443
          name: webhook-server
          protocol: TCP
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 10
{{- if .Values.resources }}
        resources:
{{ toYaml .Values.resources | indent 10 }}
{{- end }}
        securityContext:
          allowPrivilegeEscalation: false
        volumeMounts:
        - mountPath: /tmp/k8s-webhook-server/serving-certs
          name: cert
          readOnly: true
      securityContext:
        runAsNonRoot: true
      serviceAccountName: {{ include "kube-ecr-secrets-operator.name" . }}-controller-manager
      terminationGracePeriodSeconds: 10
      volumes:
      - name: cert
        emptyDir: {}
{{- if .Values.affinity }}
      affinity:
{{ toYaml .Values.affinity | indent 8 }}
{{- end }}
{{- if .Values.nodeSelector }}
      nodeSelector:
{{ toYaml .Values.nodeSelector | indent 8 }}
{{- end }}
{{- if .Values.tolerations }}
      tolerations:
{{ toYaml .Values.tolerations | indent 8 }}
{{- end }}

